# PR Screen - Flutter Implementation Brief (Screen 10/16)

**Source Analysis:** PR_SCREEN_ANALYSIS.md (comprehensive Kotlin analysis)
**Target:** Exact 1:1 match with Kotlin PersonalBestsTab

## CRITICAL FINDING

**PR Screen is NOT standalone - it's embedded in Analytics Screen as tab 1 of 3.**

DO NOT create a separate PRScreen. Instead, create `PersonalBestsTab` widget to be integrated into AnalyticsScreen's TabBarView.

## Implementation Tasks

### 1. Create 10 New Widgets

**lib/presentation/widgets/pr/personal_bests_tab.dart** (ConsumerWidget, ~200 lines)
- StreamProvider watching personal records (grouped by exercise)
- ListView.builder with PersonalRecordCard items
- Muscle group distribution chart (fl_chart PieChart)
- Workout mode distribution chart (fl_chart BarChart/PieChart)
- Empty state when no PRs
- Gradient background (same as other analytics tabs)

**lib/presentation/widgets/pr/personal_record_card.dart** (~150 lines)
- Card with rank badge, exercise name, weight, reps, mode, date
- Spring press animation (1.0 → 0.98 scale, 150ms)
- Star icon for #1 rank only
- Rank badge color coding:
  - #1: tertiary color
  - #2-3: secondary color
  - #4+: purple (#9333EA)
- 16dp card, 4dp elevation, 1dp border (#F5F3FF)

**lib/presentation/widgets/pr/pr_celebration_dialog.dart** (~250 lines)
- Full-screen dialog with confetti animation
- "NEW PR!" pulsing text (1.0 → 1.15 scale, 500ms)
- 3 gold stars (pulsing with text)
- Exercise name
- Weight badge: "{weight}/cable × {reps} reps"
- Auto-dismiss after 3 seconds
- "Tap to dismiss" hint
- Uses ConfettiPainter for animation

**lib/presentation/widgets/pr/confetti_painter.dart** (CustomPainter, ~100 lines)
- Draws 30 confetti particles
- Colors: Gold, Orange, Pink, Purple, Blue, Green
- Particle size: Random 4-12 dp
- Velocity X: Random -200 to +200 pixels
- Velocity Y: Random -800 to -1200 pixels (upward)
- Gravity: 0.5 * 980 * t²
- Rotation speed: Random -5 to +5 degrees/sec
- Opacity: Fades from 1.0 to 0.5 over 3 seconds

**lib/presentation/widgets/pr/weight_progression_chart.dart** (~150 lines)
- fl_chart LineChart
- X-axis: dates (MMM d format)
- Y-axis: weight (formatted with unit)
- Cubic bezier interpolation
- Purple line (#9333EA), 3dp width
- Show dots, below bar gradient
- Touch interactions

**lib/presentation/widgets/pr/muscle_group_distribution_chart.dart** (~100 lines)
- fl_chart PieChart
- Shows percentage of PRs per muscle group
- Color-coded segments (purple, blue, green, orange, red, violet, pink, teal)
- Legend

**lib/presentation/widgets/pr/workout_mode_distribution_chart.dart** (~100 lines)
- fl_chart BarChart or PieChart
- Shows distribution of PRs by workout mode
- Color-coded by mode

**lib/presentation/widgets/pr/rank_badge.dart** (~40 lines)
- Colored badge with "#" + rank number
- 8dp rounded corners
- Padding: horizontal 8dp, vertical 4dp
- Typography: labelMedium Bold
- Colors vary by rank (see above)

**lib/presentation/widgets/pr/pr_metadata_row.dart** (~30 lines)
- Horizontal row: "{reps} reps • {mode} • {date}"
- bodySmall typography
- onSurfaceVariant color (except mode which is secondary)
- 4dp spacing between elements

**lib/presentation/widgets/pr/empty_state_pr_card.dart** (REUSE from common/empty_state.dart or create if doesn't exist)
- Icon: Info (48dp, primary color)
- Title: "No personal records yet"
- Subtitle: "Complete workouts to see your PRs"

### 2. Database and Repository (Copilot Task - Separate)

**lib/data/database/tables/personal_records.drift** (if not exists)
- Table: personal_records
- Columns: id, exerciseId, weightPerCableKg, reps, timestamp, workoutMode
- Unique constraint: (exerciseId, workoutMode)

**lib/data/database/daos/personal_record_dao.dart**
- Add methods:
  - `Stream<List<PersonalRecord>> getAllPRsGrouped()`
  - `Future<PersonalRecord?> getLatestPR(String exerciseId, String workoutMode)`
  - `Future<PersonalRecord?> getBestPR(String exerciseId)`
  - `Future<bool> updatePRIfBetter({...})`

**lib/data/repositories/personal_record_repository.dart**
- Thin wrapper over DAO
- Exception handling
- Domain model mapping

**Domain Models (if not exist):**
- PersonalRecord class with all fields
- PRCelebrationEvent class for celebration stream

### 3. Critical Specifications from Analysis

**PersonalRecordCard Layout:**
- Left section:
  - Rank badge (8dp rounded, color by rank)
  - 16dp spacer
  - Exercise name (titleMedium Bold)
  - Weight display: "{weight}/cable" (bodyLarge, primary color)
  - Metadata row: "{reps} reps • {mode} • {date}" (bodySmall)
- Right section:
  - Star icon (32dp, primary color) if rank == 1
- Card: 16dp radius, 4dp elevation, 1dp border (#F5F3FF)
- Spring animation: scale 1.0 → 0.98, 150ms

**PRCelebrationDialog Layout:**
- Confetti layer (behind content)
- Column (centered, 32dp padding):
  - 3 gold stars (32dp each, 8dp spacing, pulsing)
  - "NEW PR!" text (headlineLarge Bold, primary color, pulsing)
  - Exercise name (titleLarge Bold)
  - Weight badge (primaryContainer, 24dp horizontal padding, 12dp vertical):
    - Text: "{weight}/cable × {reps} reps" (headlineMedium Bold, primary)
  - 8dp spacer
  - "Tap to dismiss" (bodySmall, onSurfaceVariant, alpha 0.6)

**PR Comparison Logic:**
```dart
bool isBetter(PersonalRecord newPR, PersonalRecord existingPR) {
  return newPR.weightPerCableKg > existingPR.weightPerCableKg ||
      (newPR.weightPerCableKg == existingPR.weightPerCableKg &&
       newPR.reps > existingPR.reps);
}
```

**PR Tracking Rules (CRITICAL):**
- PRs tracked ONLY for:
  - Non-Just Lift workouts
  - Non-Echo mode workouts
  - Workouts with selected exercise
  - Working reps only (exclude warmup)
- One PR per exercise+mode combination
- Weight is king (higher weight always wins)
- If weight equal, higher reps wins

**Grouping and Sorting Logic:**
```dart
// Group by exercise, get best PR per exercise
final grouped = <String, PersonalRecord>{};
for (final pr in allPRs) {
  final existing = grouped[pr.exerciseId];
  if (existing == null || isBetter(pr, existing)) {
    grouped[pr.exerciseId] = pr;
  }
}

// Sort by weight descending (heaviest first)
final sorted = grouped.entries
    .map((e) => (e.key, e.value))
    .toList()
    ..sort((a, b) => b.$2.weightPerCableKg.compareTo(a.$2.weightPerCableKg));
```

**Exercise Name Lookup:**
```dart
// Use FutureProvider.family for async lookup
final exerciseNameProvider = FutureProvider.family<String, String>((ref, id) async {
  final repo = ref.watch(exerciseRepositoryProvider);
  final exercise = await repo.getExerciseById(id);
  return exercise?.name ?? 'Unknown Exercise';
});
```

**Muscle Group Parsing:**
```dart
// Exercise muscleGroups is comma-separated string
final groups = exercise.muscleGroups
    .split(',')
    .map((g) => g.trim())
    .where((g) => g.isNotEmpty)
    .toList();
```

**Date Formatting:**
```dart
String formatPRDate(BigInt timestamp) {
  final dt = DateTime.fromMillisecondsSinceEpoch(timestamp.toInt());
  return DateFormat('MMM d, yyyy').format(dt); // "Nov 12, 2025"
}
```

### 4. State Management Pattern

```dart
// Personal Records Stream
final personalRecordsProvider = StreamProvider<List<PersonalRecord>>((ref) {
  final dao = ref.watch(personalRecordDaoProvider);
  return dao.getAllPRsGrouped();
});

// Grouped PRs (derived)
final groupedPRsProvider = Provider<List<(String, PersonalRecord)>>((ref) {
  final allPRs = ref.watch(personalRecordsProvider).value ?? [];

  final grouped = <String, PersonalRecord>{};
  for (final pr in allPRs) {
    final existing = grouped[pr.exerciseId];
    if (existing == null ||
        pr.weightPerCableKg > existing.weightPerCableKg ||
        (pr.weightPerCableKg == existing.weightPerCableKg && pr.reps > existing.reps)) {
      grouped[pr.exerciseId] = pr;
    }
  }

  return grouped.entries
      .map((e) => (e.key, e.value))
      .toList()
      ..sort((a, b) => b.$2.weightPerCableKg.compareTo(a.$2.weightPerCableKg));
});

// PR celebration event stream
final prCelebrationProvider = StreamProvider<PRCelebrationEvent?>((ref) {
  final workoutService = ref.watch(workoutServiceProvider);
  return workoutService.prCelebrationStream;
});
```

### 5. Testing Requirements

After implementation:
1. Run `flutter analyze` - must pass
2. Verify PR grouping logic works
3. Test empty state display
4. Test rank badge color coding
5. Verify confetti animation smoothness
6. Test exercise name async loading
7. Check chart rendering
8. Verify celebration dialog auto-dismiss (3 seconds)
9. Test PR comparison algorithm (weight priority, then reps)

### 6. Known Issues to Address

**From Analysis:**
1. ✓ Add loading indicator for exercise names
2. ✓ Add error handling for exercise lookup failures
3. ⚠ CSV export functionality (defer to later)
4. ⚠ Trends tab (separate task)
5. ⚠ Analytics screen integration (may need to create full AnalyticsScreen)

### 7. Files to Create/Update

**NEW:**
- lib/presentation/widgets/pr/personal_bests_tab.dart
- lib/presentation/widgets/pr/personal_record_card.dart
- lib/presentation/widgets/pr/pr_celebration_dialog.dart
- lib/presentation/widgets/pr/confetti_painter.dart
- lib/presentation/widgets/pr/weight_progression_chart.dart
- lib/presentation/widgets/pr/muscle_group_distribution_chart.dart
- lib/presentation/widgets/pr/workout_mode_distribution_chart.dart
- lib/presentation/widgets/pr/rank_badge.dart
- lib/presentation/widgets/pr/pr_metadata_row.dart
- lib/presentation/widgets/pr/empty_state_pr_card.dart (or reuse common/empty_state.dart)

**REUSE (verify exist):**
- lib/presentation/widgets/common/empty_state.dart

**UPDATE (Copilot - Separate Task):**
- lib/data/database/tables/personal_records.drift (if needed)
- lib/data/database/daos/personal_record_dao.dart
- lib/data/repositories/personal_record_repository.dart
- lib/domain/models/personal_record.dart
- lib/domain/models/pr_celebration_event.dart

**INTEGRATION (Later):**
- lib/presentation/screens/active_workout_screen.dart (add PR celebration listener)
- lib/presentation/screens/analytics_screen.dart (add Personal Bests tab)

### 8. Dependencies Required

Add to pubspec.yaml:
```yaml
dependencies:
  fl_chart: ^0.66.0  # For charts
  intl: ^0.19.0      # For date formatting (may already exist)
  collection: ^1.18.0 # For sortedBy, mapIndexed (may already exist)
```

### 9. Animation Specifications

**Confetti Animation:**
- Duration: 3 seconds (loop)
- Particle count: 30
- Particle colors: [Gold (#FFD700), Orange (#FFA500), Pink (#FF69B4), Purple (#9333EA), Blue (#3B82F6), Green (#10B981)]
- Particle size: Random 4-12 dp
- Start position: Top of dialog, random X
- Velocity X: Random -200 to +200 pixels
- Velocity Y: Random -800 to -1200 pixels (upward)
- Rotation speed: Random -5 to +5 degrees/sec
- Gravity: 0.5 * 980 * t² (pixels)
- Opacity: 1.0 - (progress * 0.5)

**Pulse Animation:**
- Duration: 500ms
- Easing: Curves.fastOutSlowIn
- Scale: 1.0 → 1.15
- Repeat mode: Reverse (infinite)
- Applied to: "NEW PR!" text and 3 stars

**Card Tap Animation:**
- Duration: 150ms
- Easing: Curves.easeInOut
- Scale: 1.0 → 0.98
- Behavior: Forward on press, reverse on release (after 100ms delay)

### 10. Color Specifications

**Rank Badge Colors:**
- Rank #1:
  - Background: MaterialTheme.colorScheme.tertiary
  - Text: MaterialTheme.colorScheme.onTertiary
- Rank #2-3:
  - Background: MaterialTheme.colorScheme.secondary
  - Text: MaterialTheme.colorScheme.onSecondary
- Rank #4+:
  - Background: Color(0xFFF5F3FF)
  - Text: Color(0xFF9333EA) (purple)

**Chart Colors:**
- Purple: Color(0xFF9333EA)
- Blue: Color(0xFF3B82F6)
- Green: Color(0xFF10B981)
- Orange: Color(0xFFF59E0B)
- Red: Color(0xFFEF4444)
- Violet: Color(0xFF8B5CF6)
- Pink: Color(0xFFEC4899)
- Teal: Color(0xFF14B8A6)

**Celebration Colors:**
- Gold: Color(0xFFFFD700)
- Orange: Color(0xFFFFA500)
- Pink: Color(0xFFFF69B4)
- Purple: Color(0xFF9333EA)
- Blue: Color(0xFF3B82F6)
- Green: Color(0xFF10B981)

### 11. Typography Specifications

| Element | Typography | FontWeight | Color |
|---------|-----------|------------|-------|
| Exercise Name (card) | titleMedium | Bold | onSurface |
| Weight Display | bodyLarge | Normal | primary |
| Reps/Mode/Date | bodySmall | Normal | onSurfaceVariant |
| Rank Badge | labelMedium | Bold | Varies by rank |
| PR Dialog "NEW PR!" | headlineLarge | Bold | primary |
| PR Dialog Exercise | titleLarge | Bold | onSurface |
| PR Dialog Weight | headlineMedium | Bold | primary |
| "Tap to dismiss" | bodySmall | Normal | onSurfaceVariant (alpha 0.6) |

### 12. Spacing Specifications

- Card padding: AppSpacing.medium (16dp)
- Between cards: AppSpacing.medium (16dp)
- Rank badge padding: horizontal 8dp, vertical 4dp
- Rank badge to exercise: AppSpacing.medium (16dp)
- Metadata elements spacing: AppSpacing.extraSmall (4dp)
- PR Dialog padding: 32dp
- PR Dialog elements spacing: AppSpacing.medium (16dp)
- Exception: "Tap to dismiss" spacing: AppSpacing.small (8dp)

See PR_SCREEN_ANALYSIS.md for complete specifications.
