# BLE Connection Components - Exact Kotlin Match

**Task:** Create missing BLE connection components and update TopAppBar to exactly match Kotlin VitruvianRedux

**Source Analysis:** BLE_CONNECTION_ANALYSIS.md (comprehensive 42KB analysis)

## Current Flutter Implementation Status

### ✅ Already Exist (Verify Match):
- `lib/presentation/widgets/overlays/connecting_overlay.dart` - Full-screen connection modal
- `lib/presentation/widgets/workout/connection_status_banner.dart` - Disconnected warning banner
- `lib/presentation/widgets/dialogs/connection_error_dialog.dart` - Error dialog with troubleshooting
- `lib/presentation/widgets/dialogs/connection_lost_dialog.dart` - Critical alert during workouts

### ❌ Missing:
- `DeviceSelectorDialog` - Manual device selection (rarely used)

### ⚠️ Needs Update:
- `lib/presentation/screens/main_screen.dart` - TopAppBar connection indicator (currently simplified)

---

## 1. Create DeviceSelectorDialog

**File:** `lib/presentation/widgets/dialogs/device_selector_dialog.dart` (NEW)

### Requirements

**Data Model:**
```dart
class ScannedDevice {
  final String name;
  final String address;  // MAC address (e.g., "00:1A:7D:DA:71:13")
  final int rssi;        // Signal strength in dBm (NOT displayed in UI)

  const ScannedDevice({
    required this.name,
    required this.address,
    this.rssi = 0,
  });
}
```

**Widget Signature:**
```dart
class DeviceSelectorDialog extends StatelessWidget {
  final List<ScannedDevice> devices;
  final bool isScanning;
  final ValueChanged<ScannedDevice> onDeviceSelected;
  final VoidCallback onRescan;
  final VoidCallback onDismiss;

  const DeviceSelectorDialog({
    super.key,
    required this.devices,
    required this.isScanning,
    required this.onDeviceSelected,
    required this.onRescan,
    required this.onDismiss,
  });
}
```

### Layout Structure

```
AlertDialog
├── onDismissRequest: onDismiss
│
├── title
│   └── Text: "Select Vitruvian Device"
│
├── content (Column with fillMaxWidth)
│   │
│   ├── [Empty State] (when devices.isEmpty)
│   │   └── Column (padding=16dp)
│   │       ├── if isScanning:
│   │       │   └── Row
│   │       │       ├── CircularProgressIndicator (size=18dp)
│   │       │       ├── SizedBox(width=8dp)
│   │       │       └── Text: "Scanning..."
│   │       └── else:
│   │           └── Text: "No devices found. Try scanning again."
│   │               └── textAlign: center, color: onSurfaceVariant
│   │
│   └── [Device List] (when devices.isNotEmpty)
│       └── LazyColumn (spacing=4dp)
│           └── for each device:
│               └── Card
│                   ├── fillMaxWidth
│                   ├── clickable: onDeviceSelected(device)
│                   ├── containerColor: surfaceVariant
│                   ├── shape: RoundedCornerShape(16.dp)
│                   │
│                   └── Row (padding=16dp)
│                       ├── Column (weight=1f)
│                       │   ├── Text (device.name)
│                       │   │   ├── style: bodyLarge
│                       │   │   ├── fontWeight: Bold
│                       │   │   └── color: onSurface
│                       │   └── Text (device.address)
│                       │       ├── style: bodySmall
│                       │       └── color: onSurfaceVariant
│                       │
│                       └── Icon (KeyboardArrowRight)
│                           ├── tint: primary
│                           └── contentDescription: null (decorative)
│
├── actions
│   ├── confirmButton (if !isScanning)
│   │   └── TextButton (onRescan)
│   │       ├── Icon: Refresh (size=18dp, tint=primary)
│   │       ├── SizedBox(width=4dp)
│   │       └── Text: "Rescan" (color=primary)
│   │
│   └── dismissButton
│       └── TextButton (onDismiss)
│           └── Text: "Cancel" (color: onSurfaceVariant)
```

### Styling Details

| Element | Property | Value |
|---------|----------|-------|
| Dialog Title | Default | AlertDialog default |
| Card Container | containerColor | surfaceVariant |
| Card | shape | RoundedCornerShape(16.dp) |
| Card Row | padding | 16dp (AppSpacing.medium) |
| Device Name | style | bodyLarge, Bold |
| Device Name | color | onSurface |
| MAC Address | style | bodySmall |
| MAC Address | color | onSurfaceVariant |
| Arrow Icon | tint | primary |
| Rescan Icon | size | 18dp |
| Rescan Icon | tint | primary |
| Scanning Indicator | size | 18dp |
| LazyColumn | spacing | 4dp (AppSpacing.extraSmall) |
| Empty State Column | padding | 16dp (AppSpacing.medium) |
| Rescan Button Icon Spacing | width | 4dp (AppSpacing.extraSmall) |
| Cancel Button Text | color | onSurfaceVariant |

### Behavior

1. **Device List Item Click**:
   - Call `onDeviceSelected(device)`
   - Dialog remains open (NO auto-dismiss)
   - Connection proceeds asynchronously

2. **Rescan Button**:
   - Only visible when `!isScanning`
   - Click calls `onRescan()`
   - Button hides while scanning

3. **Cancel Button**:
   - Click calls `onDismiss()`
   - Dialog dismisses
   - **IMPORTANT**: Scanning continues in background (matches Kotlin behavior)

4. **Empty State**:
   - Show scanning indicator if `devices.isEmpty() && isScanning`
   - Show "No devices found" if `devices.isEmpty() && !isScanning`

### Important Notes

- **RSSI NOT Displayed**: Signal strength is in data model but NOT shown in UI
- **MAC Address Format**: Display as-is (e.g., "00:1A:7D:DA:71:13")
- **Device Name**: Display as-is (no truncation/formatting)
- **Sorting**: None - devices appear in discovery order
- **No Custom Animations**: Use default Material 3 animations

---

## 2. Update TopAppBar Connection Indicator

**File:** `lib/presentation/screens/main_screen.dart` (UPDATE)

### Current Implementation Issues

Currently shows simplified Bluetooth icon (green/grey only). Needs full 5-state color-coded system.

### Required Changes

**Location:** Inside `AppBar` widget, `actions` list

**Replace Existing Icon With:**

```dart
actions: [
  Column(
    mainAxisAlignment: MainAxisAlignment.center,
    children: [
      InkWell(
        onTap: () {
          final connState = ref.read(connectionStateProvider).valueOrNull;
          if (connState is ble.Connected) {
            ref.read(bleConnectionActionsProvider).disconnect();
          } else {
            ref.read(bleConnectionActionsProvider).ensureConnection(
              onConnected: () {},
              onFailed: () {},
            );
          }
        },
        child: Container(
          constraints: const BoxConstraints(
            minWidth: 48,
            minHeight: 48,
          ),
          padding: const EdgeInsets.symmetric(horizontal: 4),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                _getConnectionIcon(connectionState),
                size: 20,
                color: _getConnectionColor(connectionState),
              ),
              Text(
                _getConnectionText(connectionState),
                style: theme.textTheme.labelSmall?.copyWith(
                  fontSize: 9,
                  color: _getConnectionColor(connectionState),
                ),
                maxLines: 1,
              ),
            ],
          ),
        ),
      ),
    ],
  ),
],
```

### Helper Methods

Add these methods to `MainScreen` widget:

```dart
IconData _getConnectionIcon(ble.ConnectionState? state) {
  return state?.when(
    disconnected: () => Icons.bluetooth_disabled,
    scanning: () => Icons.bluetooth_searching,
    connecting: () => Icons.bluetooth_searching,
    connected: (address) => Icons.bluetooth,
    connectionError: (message) => Icons.bluetooth_disabled,
  ) ?? Icons.bluetooth_disabled;
}

Color _getConnectionColor(ble.ConnectionState? state) {
  return state?.when(
    disconnected: () => const Color(0xFFEF4444),    // red-500
    scanning: () => const Color(0xFF3B82F6),        // blue-500
    connecting: () => const Color(0xFFFBBF24),      // yellow-400
    connected: (address) => const Color(0xFF22C55E), // green-500
    connectionError: (message) => const Color(0xFFEF4444), // red-500
  ) ?? const Color(0xFFEF4444);
}

String _getConnectionText(ble.ConnectionState? state) {
  return state?.when(
    disconnected: () => 'Disconnected',
    scanning: () => 'Scanning',
    connecting: () => 'Connecting',
    connected: (address) => 'Connected',
    connectionError: (message) => 'Error',
  ) ?? 'Disconnected';
}
```

### Color Reference

| State | Icon | Color | Hex Code |
|-------|------|-------|----------|
| Connected | `Icons.bluetooth` | Green | `#22C55E` (green-500) |
| Connecting | `Icons.bluetooth_searching` | Yellow | `#FBBF24` (yellow-400) |
| Disconnected | `Icons.bluetooth_disabled` | Red | `#EF4444` (red-500) |
| Scanning | `Icons.bluetooth_searching` | Blue | `#3B82F6` (blue-500) |
| Error | `Icons.bluetooth_disabled` | Red | `#EF4444` (red-500) |

### Styling Details

| Element | Property | Value |
|---------|----------|-------|
| Container | minWidth | 48dp (touch target) |
| Container | minHeight | 48dp (touch target) |
| Container | horizontal padding | 4dp |
| Icon | size | 20dp |
| Icon | color | Dynamic (see table above) |
| Text | style | labelSmall |
| Text | fontSize | 9sp (override) |
| Text | color | Matches icon color |
| Text | maxLines | 1 |

### Behavior

1. **Click Action**:
   - If `Connected` → Call `disconnect()`
   - If NOT Connected → Call `ensureConnection(onConnected: {}, onFailed: {})`
   - No action during Connecting/Scanning (auto-connect in progress)

2. **Accessibility**:
   - Minimum touch target: 48dp × 48dp
   - Use `Semantics` for screen readers

3. **State Updates**:
   - Reactive to `connectionStateProvider` changes
   - Icon and color change instantly (no animation)

---

## 3. Verify Existing Components Match Kotlin Specs

### ConnectingOverlay

**File:** `lib/presentation/widgets/overlays/connecting_overlay.dart`

**Check:**
- Full-screen modal with scrim @ 60% opacity
- Card with 32dp padding
- CircularProgressIndicator (48dp size)
- Title: "Connecting to device..." (titleMedium)
- Subtitle: "Scanning for Vitruvian Trainer" (bodySmall, onSurfaceVariant)
- Cancel button with 8dp top padding
- Dialog properties: `barrierDismissible: false`

### ConnectionStatusBanner

**File:** `lib/presentation/widgets/workout/connection_status_banner.dart`

**Check:**
- Card with surfaceContainerHighest background
- Row with Bluetooth icon (error color, 24dp)
- Message: "Not connected to machine" (bodyMedium, Medium weight)
- Connect button (TextButton, labelLarge, Bold)
- Padding: 16dp horizontal, 8dp vertical (card), 16dp internal (row)

### ConnectionErrorDialog

**File:** `lib/presentation/widgets/dialogs/connection_error_dialog.dart`

**Check:**
- AlertDialog with Warning icon
- Title: "Connection Failed"
- Error message (bodyMedium)
- Divider (4dp padding vertical)
- Troubleshooting header: "Troubleshooting tips:" (labelLarge, Bold, primary color)
- 4 bullet points (bodySmall):
  - "• Ensure the machine is powered on"
  - "• Try turning Bluetooth off and on"
  - "• Move closer to the machine"
  - "• Check that no other device is connected"
- Retry button (if onRetry provided)
- OK/Dismiss button

### ConnectionLostDialog

**File:** `lib/presentation/widgets/dialogs/connection_lost_dialog.dart`

**Check:**
- AlertDialog with BluetoothDisabled icon (tint: error)
- Title: "Connection Lost" (headlineSmall, Bold)
- Message: "Bluetooth connection to the trainer was lost during your workout." (bodyLarge)
- Spacer (8dp)
- Secondary message: "Rep tracking may have been interrupted. Please reconnect to continue." (bodyMedium, onSurfaceVariant)
- Reconnect button (Bold)
- Dismiss button

---

## 4. Integration Notes

### BLE Provider Structure

Ensure these providers exist in `lib/presentation/providers/ble_connection_provider.dart`:

```dart
// Connection state (from repository)
final connectionStateProvider = StreamProvider<ConnectionState>((ref) {
  final repo = ref.watch(bleRepositoryProvider);
  return repo.connectionState;
});

// Scanned devices
final scannedDevicesProvider = StreamProvider<List<ScannedDevice>>((ref) {
  final repo = ref.watch(bleRepositoryProvider);
  return repo.scannedDevices;
});

// Actions provider
final bleConnectionActionsProvider = Provider<BleConnectionActions>((ref) {
  return BleConnectionActions(ref);
});

class BleConnectionActions {
  final Ref _ref;

  BleConnectionActions(this._ref);

  Future<void> startScanning() async { /* ... */ }
  Future<void> stopScanning() async { /* ... */ }
  Future<void> connectToDevice(String address) async { /* ... */ }
  Future<void> disconnect() async { /* ... */ }
  Future<void> ensureConnection({
    required VoidCallback onConnected,
    required VoidCallback onFailed,
  }) async { /* ... */ }
  Future<void> cancelAutoConnecting() async { /* ... */ }
}
```

### Auto-Connect Flow

The auto-connect flow (triggered from Just Lift, Active Workout, etc.):

1. User action requires connection
2. Check current state: if Connected → proceed, else → auto-connect
3. Show `ConnectingOverlay` (set `isAutoConnecting = true`)
4. Start scanning
5. Wait for first device (30s timeout)
6. Connect to first device (15s timeout)
7. On success: hide overlay, call onConnected
8. On failure: hide overlay, show `ConnectionErrorDialog`, call onFailed
9. User can cancel: hide overlay, stop scan, clear state

### Manual Device Selection (Rare)

The `DeviceSelectorDialog` is used when:
- User manually taps connection icon in TopAppBar
- Auto-connect is NOT triggered
- User wants to see available devices

**Flow:**
1. User taps connection icon (when disconnected)
2. Start scanning
3. Show `DeviceSelectorDialog` with scanned devices
4. User selects device from list
5. Connect to selected device
6. Dialog remains open during connection
7. Connection state updates → dialog can be dismissed

---

## 5. Implementation Checklist

### New Components
- [ ] Create `ScannedDevice` model in `lib/domain/models/scanned_device.dart`
- [ ] Create `DeviceSelectorDialog` widget
  - [ ] AlertDialog with title
  - [ ] Empty state (scanning indicator + "No devices found")
  - [ ] Device list with LazyColumn
  - [ ] Device card with name + MAC address
  - [ ] Arrow icon on each card
  - [ ] Rescan button (only when !isScanning)
  - [ ] Cancel button
  - [ ] Proper spacing (4dp list, 16dp card padding)
  - [ ] surfaceVariant card background
  - [ ] RoundedCornerShape(16dp) cards
  - [ ] clickable cards with onDeviceSelected callback

### Updated Components
- [ ] Update `main_screen.dart` TopAppBar connection indicator
  - [ ] Column with icon + text
  - [ ] 5-state color system (green, yellow, red, blue, grey)
  - [ ] Dynamic icon (bluetooth, bluetooth_searching, bluetooth_disabled)
  - [ ] 20dp icon size
  - [ ] 9sp text size (labelSmall override)
  - [ ] 48dp minimum touch target
  - [ ] 4dp horizontal padding
  - [ ] Click handler (connect/disconnect)
  - [ ] Add helper methods: _getConnectionIcon, _getConnectionColor, _getConnectionText

### Verification
- [ ] Verify `ConnectingOverlay` matches Kotlin specs
- [ ] Verify `ConnectionStatusBanner` matches Kotlin specs
- [ ] Verify `ConnectionErrorDialog` matches Kotlin specs
- [ ] Verify `ConnectionLostDialog` matches Kotlin specs
- [ ] Run `flutter analyze` (no errors)
- [ ] Test device selector dialog rendering
- [ ] Test TopAppBar icon state changes

---

## 6. Spacing & Styling Reference

### Spacing (8dp Grid)
- extraSmall: 4dp
- small: 8dp
- medium: 16dp
- large: 24dp
- extraLarge: 32dp
- huge: 48dp

### Typography
| Style | Font Size | Weight | Line Height | Letter Spacing |
|-------|-----------|--------|-------------|----------------|
| headlineSmall | 24sp | SemiBold | 32sp | 0 |
| titleMedium | 16sp | Medium | 24sp | 0.15sp |
| bodyLarge | 16sp | Normal | 24sp | 0.5sp |
| bodyMedium | 14sp | Normal | 20sp | 0.25sp |
| bodySmall | 12sp | Normal | 16sp | 0.4sp |
| labelLarge | 14sp | Medium | 20sp | 0.1sp |
| labelSmall | 11sp | Medium | 16sp | 0.5sp |

### Corner Radius
- Device cards: 16dp
- Dialog: Default Material 3

### Icon Sizes
- TopAppBar connection icon: 20dp
- Scanning indicator (dialog): 18dp
- Scanning indicator (overlay): 48dp
- Refresh icon: 18dp
- Banner Bluetooth icon: 24dp
- Touch target minimum: 48dp × 48dp

---

## 7. Expected Outcome

After implementation:

1. ✅ DeviceSelectorDialog widget created and functional
2. ✅ TopAppBar connection indicator shows 5 color-coded states
3. ✅ All existing connection components verified against Kotlin specs
4. ✅ Auto-connect flow works seamlessly
5. ✅ Manual device selection available (rare use case)
6. ✅ Connection status always visible in TopAppBar
7. ✅ No errors in `flutter analyze`
8. ✅ BLE connection UI matches Kotlin pixel-perfect

### Visual Match Verification

**TopAppBar Icon States:**
- Disconnected: Red bluetooth_disabled icon + "Disconnected" text
- Scanning: Blue bluetooth_searching icon + "Scanning" text
- Connecting: Yellow bluetooth_searching icon + "Connecting" text
- Connected: Green bluetooth icon + "Connected" text
- Error: Red bluetooth_disabled icon + "Error" text

**DeviceSelectorDialog:**
- Empty state with scanning indicator
- Device list with name + MAC address
- Arrow icons on cards
- Rescan button (only when not scanning)
- Cancel button
- surfaceVariant card backgrounds

**Existing Components:**
- ConnectingOverlay: Full-screen modal with 48dp progress indicator
- ConnectionStatusBanner: Error color icon, connect button
- ConnectionErrorDialog: Warning icon, troubleshooting tips
- ConnectionLostDialog: Error icon, reconnect button
