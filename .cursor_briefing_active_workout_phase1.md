# Active Workout Screen - Phase 1: Core UI Matching

**Task:** Update Flutter ActiveWorkoutScreen to match Kotlin WorkoutTab.kt visual structure

**Source Analysis:** WORKOUTTAB_ANALYSIS.md (1,453 lines)

## Scope: Phase 1 (Core Visual Structure)

This phase focuses on the visual layout and structure. Complex features (workout setup dialog, haptic feedback, video player) will be addressed in Phase 2.

### Current Flutter Implementation Problems

❌ Has AppBar (Kotlin has no AppBar - full immersive)
❌ No gradient background
❌ Position bars in center (should be on edges)
❌ No connection card
❌ No workout setup card
❌ No state-specific cards (Idle, Error, Completed, Active)
❌ Basic metrics display (should be styled card)
❌ No proper Z-order layering
❌ Wrong spacing and padding

### Required Changes - Phase 1

## 1. Remove AppBar, Add Gradient Background

```dart
// REMOVE: Scaffold with AppBar
// ADD: Container with gradient

return Container(
  decoration: BoxDecoration(
    gradient: LinearGradient(
      begin: Alignment.topCenter,
      end: Alignment.bottomCenter,
      colors: isDark
        ? [Color(0xFF0F172A), Color(0xFF312E81), Color(0xFF0F172A)] // Slate → Purple → Slate
        : [Color(0xFFF8FAFC), Color(0xFFF5F3FF), Color(0xFFEFF6FF)], // Slate → Purple → Blue
    ),
  ),
  child: SafeArea(
    child: Stack(...), // Stack for Z-order layering
  ),
)
```

## 2. Implement Edge Position Bars

**Structure:**
```dart
Stack(
  children: [
    // Left position bar (edge)
    Positioned(
      left: 0,
      top: 0,
      bottom: 0,
      width: 40,
      child: VerticalCablePositionBar(
        position: state.currentMetric?.positionA ?? 0,
        label: 'L',
        isLeft: true,
      ),
    ),

    // Center content (scrollable)
    Positioned(
      left: 56,  // 40dp bar + 16dp gap
      right: 56,
      top: 0,
      bottom: 0,
      child: SingleChildScrollView(...),
    ),

    // Right position bar (edge)
    Positioned(
      right: 0,
      top: 0,
      bottom: 0,
      width: 40,
      child: VerticalCablePositionBar(
        position: state.currentMetric?.positionB ?? 0,
        label: 'R',
        isLeft: false,
      ),
    ),

    // Overlays (floating on top)
    if (showCountdown) CountdownCard(...),
    if (showRestTimer) RestTimerCard(...),
    if (showSetSummary) SetSummaryCard(...),
  ],
)
```

## 3. Update VerticalCablePositionBar Widget

**File:** `lib/presentation/widgets/workout/cable_position_indicator.dart`

**Changes needed:**
- Width: 40dp (currently 80dp)
- Padding: 4dp horizontal, 8dp vertical
- Position indicator: Filled rounded rectangle (not just line)
- Background: surfaceContainerHighest (semi-transparent)
- Percentage display: "{percentage}%" text at indicator position
- Gradient fill behind indicator (primary color with opacity)

**Structure:**
```dart
Container(
  width: 40,
  padding: EdgeInsets.symmetric(horizontal: 4, vertical: 8),
  child: Stack(
    children: [
      // Background container
      Container(
        decoration: BoxDecoration(
          color: theme.colorScheme.surfaceContainerHighest.withOpacity(0.3),
          borderRadius: BorderRadius.circular(8),
        ),
      ),

      // Gradient fill (from bottom to current position)
      Positioned(
        bottom: 0,
        left: 0,
        right: 0,
        height: height * (position / 1000), // 0-1000 → 0%-100%
        child: Container(
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.bottomCenter,
              end: Alignment.topCenter,
              colors: [
                theme.colorScheme.primary.withOpacity(0.5),
                theme.colorScheme.primary.withOpacity(0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      ),

      // Position indicator (rounded rectangle)
      Positioned(
        bottom: height * (position / 1000) - 12, // Center on position
        left: 0,
        right: 0,
        child: Container(
          height: 24,
          decoration: BoxDecoration(
            color: theme.colorScheme.primary,
            borderRadius: BorderRadius.circular(4),
          ),
          child: Center(
            child: Text(
              '${(position / 10).toStringAsFixed(0)}%',
              style: TextStyle(
                color: theme.colorScheme.onPrimary,
                fontSize: 10,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
        ),
      ),

      // Label at top
      Positioned(
        top: 0,
        left: 0,
        right: 0,
        child: Text(
          label, // 'L' or 'R'
          textAlign: TextAlign.center,
          style: TextStyle(
            color: theme.colorScheme.onSurfaceVariant,
            fontSize: 12,
            fontWeight: FontWeight.bold,
          ),
        ),
      ),
    ],
  ),
)
```

## 4. Create State-Specific Cards

### Connection Card
**File:** `lib/presentation/widgets/workout/connection_card.dart` (new)

```dart
class ConnectionCard extends StatelessWidget {
  final ConnectionState connectionState;
  final VoidCallback onScan;
  final VoidCallback onDisconnect;

  // Card with:
  // - 16dp padding
  // - Surface color background
  // - 16dp rounded corners
  // - Status icon (color-coded: green=connected, yellow=connecting, red=disconnected)
  // - Status text
  // - Action button (Scan or Disconnect)
}
```

### Idle State Card
**File:** `lib/presentation/widgets/workout/idle_state_card.dart` (new)

```dart
class IdleStateCard extends StatelessWidget {
  final VoidCallback onShowSetup;

  // Card with:
  // - Center-aligned content
  // - Large "Start Workout" button
  // - Icon: PlayArrow
  // - Calls onShowSetup when tapped
}
```

### Active State Card
**File:** `lib/presentation/widgets/workout/active_state_card.dart` (new)

```dart
class ActiveStateCard extends StatelessWidget {
  final VoidCallback onStop;
  final int? justLiftTimer; // seconds, null if not in Just Lift mode

  // Card with:
  // - Stop button (filled, primary color)
  // - Just Lift timer display (if justLiftTimer != null)
  // - Timer format: "M:SS"
}
```

### Rep Counter Card
**File:** `lib/presentation/widgets/workout/rep_counter_card.dart` (new)

```dart
class RepCounterCard extends StatelessWidget {
  final int warmupReps;
  final int workingReps;
  final int totalReps;
  final bool isWarmup;

  // Card with:
  // - Large total reps display (96sp, extraBold)
  // - Warmup/Working label
  // - Warmup reps count (if isWarmup)
  // - Working reps count
  // - Format: "Warmup: {warmupReps} | Working: {workingReps}"
}
```

### Current Exercise Card
**File:** `lib/presentation/widgets/workout/current_exercise_card.dart` (new)

```dart
class CurrentExerciseCard extends StatelessWidget {
  final String exerciseName;
  final int currentSet;
  final int totalSets;
  final String? videoUrl; // For Phase 2
  final bool enableVideoPlayback;

  // Card with:
  // - Exercise name (titleLarge, bold)
  // - Set progress: "Set {current} of {total}"
  // - Video placeholder (200dp height) - Phase 2: actual video player
  // - Rounded corners (16dp)
}
```

### Live Metrics Card
**File:** `lib/presentation/widgets/workout/live_metrics_card.dart` (new)

```dart
class LiveMetricsCard extends StatelessWidget {
  final WorkoutMetric? currentMetric;
  final WeightUnit weightUnit;
  final bool showDuringWarmup; // false = hide during warmup

  // Card with:
  // - Current force (both cables, per-cable)
  // - Peak force
  // - Average force
  // - Cable position percentages
  // - Format: "{value} {unit}" (1 decimal)
  // - Grid layout (2 columns)
}
```

## 5. Update Main Workout Body Structure

```dart
Widget _buildWorkoutBody(BuildContext context, WidgetRef ref, WorkoutSessionState state) {
  return Stack(
    children: [
      // Left position bar
      Positioned(...),

      // Center content
      Positioned(
        left: 56,
        right: 56,
        top: 0,
        bottom: 0,
        child: SingleChildScrollView(
          padding: EdgeInsets.symmetric(vertical: 20),
          child: Column(
            children: [
              // Connection Card (always visible if showConnectionCard)
              ConnectionCard(...),
              SizedBox(height: 16),

              // State-specific cards
              ...state.workoutState.when(
                idle: () => [IdleStateCard(...)],
                countdown: (sec) => [], // Countdown is overlay, not in scroll
                active: () => [
                  ActiveStateCard(...),
                  SizedBox(height: 16),
                  RepCounterCard(...),
                  SizedBox(height: 16),
                  CurrentExerciseCard(...),
                  SizedBox(height: 16),
                  if (!state.repCount.isWarmup)
                    LiveMetricsCard(...),
                ],
                resting: (...) => [], // Rest timer is overlay
                setSummary: (...) => [], // Set summary is overlay
                completed: () => [CompletedStateCard(...)],
                error: (msg) => [ErrorStateCard(message: msg)],
              ),
            ],
          ),
        ),
      ),

      // Right position bar
      Positioned(...),

      // Overlays (floating)
      if (state.workoutState is Countdown)
        Positioned(
          top: MediaQuery.of(context).size.height * 0.3,
          left: 0,
          right: 0,
          child: CountdownCard(...),
        ),

      if (state.workoutState is Resting)
        Positioned(
          top: MediaQuery.of(context).size.height * 0.3,
          left: 0,
          right: 0,
          child: RestTimerCard(...),
        ),

      if (state.workoutState is SetSummary)
        Positioned(
          top: MediaQuery.of(context).size.height * 0.2,
          left: 0,
          right: 0,
          child: SetSummaryCard(...),
        ),
    ],
  );
}
```

## Implementation Checklist

- [ ] Remove Scaffold AppBar, use Container with gradient
- [ ] Implement Stack-based layout with Positioned widgets
- [ ] Create/update VerticalCablePositionBar (40dp width, edge placement)
- [ ] Create ConnectionCard widget
- [ ] Create IdleStateCard widget
- [ ] Create ActiveStateCard widget
- [ ] Create RepCounterCard widget
- [ ] Create CurrentExerciseCard widget (video placeholder for now)
- [ ] Create LiveMetricsCard widget
- [ ] Update CountdownCard to be overlay (already exists, verify positioning)
- [ ] Update RestTimerCard to be overlay (already exists, verify positioning)
- [ ] Update SetSummaryCard to be overlay (already exists, verify positioning)
- [ ] Position bars on edges (left: 0, right: 0, width: 40)
- [ ] Center content with 56dp margins (40dp bar + 16dp gap)
- [ ] Apply gradient background colors (light/dark)
- [ ] Verify Z-order: bars → content → overlays
- [ ] Test with all workout states
- [ ] Run flutter analyze

## Phase 2 (Future Session)

Deferred to next session:
- Workout Setup Dialog (7 configuration sections)
- Number picker with drag interaction
- Echo mode configuration
- TUT variant selector
- Video player integration
- Haptic feedback
- Force graph in Set Summary
- Auto-stop UI refinements

## Verification

After Phase 1:
- ✅ Full immersive layout (no AppBar)
- ✅ Gradient background matches Kotlin
- ✅ Position bars on edges (40dp width)
- ✅ Center content scrollable (56dp margins)
- ✅ State-specific cards display correctly
- ✅ Overlays float on top
- ✅ Connection status visible
- ✅ Rep counter prominent
- ✅ Live metrics card (hidden during warmup)
- ✅ Spacing matches Kotlin (16dp between cards, 20dp vertical padding)
