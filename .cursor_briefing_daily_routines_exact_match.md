# Daily Routines Screen - Flutter Implementation Brief (Screen 11/16)

**Source Analysis:** DAILY_ROUTINES_ANALYSIS.md (47KB comprehensive Kotlin analysis)
**Target:** Exact 1:1 match with Kotlin DailyRoutinesScreen + RoutinesTab + RoutineBuilderDialog

**COMPLEXITY WARNING:** High (8/10) - ~315 widgets at peak, nested modals, complex algorithms

## Implementation Priority

**CRITICAL:** This is TOO COMPLEX for a single task. Implement in phases:

### Phase 1 (THIS TASK): Core UI Only
- DailyRoutinesScreen wrapper
- RoutinesTab with routine list
- RoutineCard (simplified - NO builder yet)
- Empty state
- Basic navigation

**Skip for now (Phase 2):**
- RoutineBuilderDialog
- ExerciseListItem
- Exercise edit bottom sheet
- Exercise picker integration

## Phase 1 Implementation Tasks

### 1. Create 4 Core Widgets

**lib/presentation/screens/daily_routines_screen.dart** (~50 lines)
- Wrapper screen with gradient background
- Routes to RoutinesTab
- Handles BLE auto-connect overlay
- Material 3 scaffold

**lib/presentation/widgets/routines/routines_tab.dart** (~150 lines)
- StreamProvider watching routines list
- ListView.separated with RoutineCard items
- Empty state when no routines
- Gradient background
- Floating action button ("+") - DISABLED for now (no builder yet)

**lib/presentation/widgets/routines/routine_card.dart** (~200 lines)
- Card with routine info
- Exercise count, total sets, duration estimate
- Dropdown menu (Edit/Duplicate/Delete) - Edit/Duplicate DISABLED for now
- Press animation (scale 1.0 → 0.98, 100ms)
- "Start Workout" button
- Set/rep formatting display
- Weight display logic

**lib/presentation/widgets/routines/empty_routines_state.dart** (~40 lines)
- Empty state with icon
- "No Routines Yet" message
- "Create your first routine" subtitle
- Note about builder coming in Phase 2

### 2. Critical Specifications from Analysis

**RoutineCard Layout:**
- Top section:
  - Routine name (titleLarge Bold, onSurface)
  - Dropdown menu icon (top-right, 3 dots)
- Middle section:
  - Exercise count: "{count} exercises" (bodyMedium, onSurfaceVariant)
  - Total sets: "{sets} sets" (bodyMedium, onSurfaceVariant)
  - Duration: "{mins} min" (bodyMedium, onSurfaceVariant)
- Bottom section:
  - Set/rep preview: "3×10, 2×8" format (bodySmall, onSurfaceVariant)
  - Weight preview: First exercise weight (bodySmall, primary)
- Action button:
  - "Start Workout" (filled button, primary color)
- Card styling:
  - 16dp radius, 2dp elevation
  - 16dp padding
  - Border: 1dp #E0E0E0
  - Press animation: scale 1.0 → 0.98, 100ms

**Set/Rep Formatting Algorithm (CRITICAL):**
```dart
String formatSetReps(List<int> reps) {
  if (reps.isEmpty) return "0 sets";

  // Group consecutive identical reps
  final groups = <String>[];
  int count = 1;
  int current = reps[0];

  for (int i = 1; i < reps.length; i++) {
    if (reps[i] == current) {
      count++;
    } else {
      groups.add(count > 1 ? "$count×$current" : "$current");
      current = reps[i];
      count = 1;
    }
  }
  groups.add(count > 1 ? "$count×$current" : "$current");

  return groups.join(", ");
}
```

**Duration Estimation Algorithm:**
```dart
int estimateDuration(Routine routine) {
  int totalSeconds = 0;

  for (final exercise in routine.exercises) {
    final repsInSet = exercise.setReps.isNotEmpty ? exercise.setReps[0] : 0;
    final sets = exercise.setReps.length;

    // 3 seconds per rep
    totalSeconds += repsInSet * sets * 3;

    // Rest time between sets (exclude last set)
    if (sets > 1) {
      totalSeconds += exercise.restTimeSeconds * (sets - 1);
    }
  }

  return (totalSeconds / 60).ceil(); // Convert to minutes
}
```

**Weight Display Logic:**
```dart
String formatRoutineWeight(Routine routine, WeightUnit unit, Function formatWeight) {
  if (routine.exercises.isEmpty) return "";

  final firstExercise = routine.exercises[0];

  // Check if variable weights (per-set)
  if (firstExercise.perSetWeights != null && firstExercise.perSetWeights!.isNotEmpty) {
    final weights = firstExercise.perSetWeights!;
    final uniqueWeights = weights.toSet();

    if (uniqueWeights.length == 1) {
      // All same weight
      return formatWeight(weights[0], unit);
    } else {
      // Range
      final min = weights.reduce(math.min);
      final max = weights.reduce(math.max);
      return "${formatWeight(min, unit)}-${formatWeight(max, unit)}";
    }
  }

  // Default weight
  return formatWeight(firstExercise.weightPerCableKg, unit);
}
```

**Dropdown Menu Actions:**
```dart
PopupMenuButton<String>(
  icon: const Icon(Icons.more_vert),
  itemBuilder: (context) => [
    const PopupMenuItem(value: 'edit', enabled: false, child: Text('Edit (Phase 2)')),
    const PopupMenuItem(value: 'duplicate', enabled: false, child: Text('Duplicate (Phase 2)')),
    const PopupMenuItem(value: 'delete', child: Text('Delete')),
  ],
  onSelected: (value) {
    if (value == 'delete') {
      _showDeleteConfirmation(routine);
    }
  },
)
```

### 3. State Management Pattern

```dart
// Routines stream provider
final routinesProvider = StreamProvider<List<Routine>>((ref) {
  final dao = ref.watch(routineDaoProvider);
  return dao.watchAllRoutines();
});

// Weight unit provider (already exists)
final weightUnitProvider = StateProvider<WeightUnit>((ref) {
  // Get from preferences
});

// Format weight action (already exists)
final formatWeightProvider = Provider<String Function(double, WeightUnit)>((ref) {
  return (weight, unit) {
    // Format logic
  };
});
```

### 4. Navigation Flow

```dart
// Start workout from routine
void _startWorkout(BuildContext context, Routine routine) async {
  // 1. Load routine into ViewModel
  final viewModel = ref.read(mainViewModelProvider);
  await viewModel.loadRoutine(routine);

  // 2. Navigate to ActiveWorkoutScreen
  Navigator.pushNamed(context, '/active-workout');
}
```

### 5. Gradient Background

```dart
// Dark mode gradient
Container(
  decoration: BoxDecoration(
    gradient: LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: [
        Color(0xFF1E293B), // slate-900
        Color(0xFF312E81), // indigo-950
        Color(0xFF1E3A8A), // blue-950
      ],
    ),
  ),
)

// Light mode gradient
Container(
  decoration: BoxDecoration(
    gradient: LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: [
        Color(0xFFC7D2FE), // indigo-200
        Color(0xFFFBCFE8), // pink-100
        Color(0xFFDDD6FE), // violet-200
      ],
    ),
  ),
)
```

### 6. Testing Requirements (Phase 1)

After implementation:
1. Run `flutter analyze` - must pass
2. Verify routine list displays correctly
3. Test empty state
4. Test delete with confirmation
5. Verify set/rep formatting (test: [10,10,10,8,8] → "3×10, 2×8")
6. Test duration calculation
7. Check weight display (single/range)
8. Verify press animations

### 7. Phase 2 (Future Task - NOT NOW)

**Deferred to separate task:**
- RoutineBuilderDialog (401 lines)
- ExerciseListItem with reordering
- Exercise edit bottom sheet
- Exercise picker integration
- Edit/Duplicate functionality
- Floating action button activation

**Reason for deferral:** Phase 2 involves complex nested modals, exercise picker integration, and smart duplication logic (12-16 hour estimate total). Better to implement core UI first, verify it works, then add builder functionality.

### 8. Files to Create/Update

**NEW (Phase 1):**
- lib/presentation/screens/daily_routines_screen.dart (~50 lines)
- lib/presentation/widgets/routines/routines_tab.dart (~150 lines)
- lib/presentation/widgets/routines/routine_card.dart (~200 lines)
- lib/presentation/widgets/routines/empty_routines_state.dart (~40 lines)

**REUSE (verify exist):**
- lib/presentation/widgets/common/empty_state.dart (or create empty_routines_state)
- lib/presentation/widgets/dialogs/delete_confirmation_dialog.dart

**DEFER (Phase 2):**
- lib/presentation/widgets/routines/routine_builder_dialog.dart
- lib/presentation/widgets/routines/exercise_list_item.dart
- lib/presentation/widgets/routines/exercise_edit_bottom_sheet.dart

### 9. Dependencies

Already in pubspec.yaml (no new deps needed):
```yaml
dependencies:
  flutter_riverpod: ^2.5.1
  drift: ^2.16.0
  intl: ^0.19.0
```

### 10. Typography Specifications

| Element | Typography | FontWeight | Color |
|---------|-----------|------------|-------|
| Routine Name | titleLarge | Bold | onSurface |
| Exercise Count | bodyMedium | Normal | onSurfaceVariant |
| Total Sets | bodyMedium | Normal | onSurfaceVariant |
| Duration | bodyMedium | Normal | onSurfaceVariant |
| Set/Rep Preview | bodySmall | Normal | onSurfaceVariant |
| Weight Preview | bodySmall | Normal | primary |
| Empty State Title | titleLarge | Bold | onSurface |
| Empty State Message | bodyMedium | Normal | onSurfaceVariant |

### 11. Spacing Specifications

- Card padding: AppSpacing.medium (16dp)
- Between cards: AppSpacing.medium (16dp)
- Icon to text: AppSpacing.small (8dp)
- Vertical spacing in card: AppSpacing.small (8dp)
- FAB position: bottom-right, 16dp margin

### 12. Color Specifications

- Card border: Color(0xFFE0E0E0) (light grey)
- Dropdown divider: Color(0xFFE0E0E0)
- Delete text: theme.colorScheme.error
- Primary button: theme.colorScheme.primary

See DAILY_ROUTINES_ANALYSIS.md for complete specifications.

## IMPORTANT NOTES FOR CURSOR

1. **This is Phase 1 only** - Do NOT implement RoutineBuilderDialog or exercise editing
2. **Disable builder-related buttons** - FAB and Edit/Duplicate menu items should be disabled
3. **Focus on display** - Core focus is displaying routines correctly
4. **Algorithms are critical** - Set/rep formatting and duration calculation must match Kotlin exactly
5. **Test formatting** - Verify "[10,10,10,8,8]" → "3×10, 2×8"

After Phase 1 completion, we'll implement Phase 2 (builder) in a separate task.
