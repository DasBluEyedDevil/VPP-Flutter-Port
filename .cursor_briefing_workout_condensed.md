# Workout Session Provider - Condensed Briefing

## Quick Reference
**Full Analysis:** See `WORKOUT_ANALYSIS.md` (441 lines) and `.cursor_briefing_workout_provider.md` (827 lines) for complete details

**Target:** `lib/presentation/providers/workout_session_provider.dart` (~500-600 lines)

## Core Task
Port workout state machine from MainViewModel.kt (lines 57-1155) to Riverpod provider

## State Model
```dart
@freezed
class WorkoutSessionState with _$WorkoutSessionState {
  const factory WorkoutSessionState({
    @Default(WorkoutState.idle()) WorkoutState workoutState,
    WorkoutMetric? currentMetric,
    required WorkoutParameters workoutParameters,
    @Default(RepCount()) RepCount repCount,
    RepRanges? repRanges,
    @Default(AutoStopUiState()) AutoStopUiState autoStopState,
    int? autoStartCountdown,
    Routine? loadedRoutine,
    @Default(0) int currentExerciseIndex,
    @Default(0) int currentSetIndex,
    @Default(false) bool connectionLostDuringWorkout,
    String? currentSessionId,
    int? workoutStartTime,
    @Default([]) List<WorkoutMetric> collectedMetrics,
  }) = _WorkoutSessionState;
}
```

## 9-State Machine (WorkoutState)
```dart
@freezed
class WorkoutState with _$WorkoutState {
  const factory WorkoutState.idle() = Idle;
  const factory WorkoutState.countdown({required int secondsRemaining}) = Countdown;
  const factory WorkoutState.active() = Active;
  const factory WorkoutState.setSummary({
    required List<WorkoutMetric> metrics,
    required double peakPower,
    required double averagePower,
    required int repCount,
  }) = SetSummary;
  const factory WorkoutState.resting({
    required int restSecondsRemaining,
    required String nextExerciseName,
    required bool isLastExercise,
    required int currentSet,
    required int totalSets,
  }) = Resting;
  const factory WorkoutState.paused() = Paused;
  const factory WorkoutState.completed() = Completed;
  const factory WorkoutState.error({required String message}) = WorkoutError;
  const factory WorkoutState.initializing() = Initializing;
}
```

## Critical Methods (13 total)

### 1. startWorkout (lines 733-817)
- Optional 5s countdown (skip if Just Lift)
- Reset rep counter
- Generate session UUID
- Transition to Active
- Emit WORKOUT_START haptic

### 2. stopWorkout (lines 819-865)
- Cancel all timers
- Save session
- Transition to Completed

### 3. handleSetCompletion (lines 888-928)
- Calculate metrics (peak/avg power)
- Transition to SetSummary

### 4. proceedFromSummary (lines 946-1018)
- **CRITICAL:** If Just Lift → Idle (NOT Completed)
- Else: startRestTimer() or Completed

### 5. startRestTimer (lines 1043-1155)
- Duration: exercise.restSeconds or 90s
- Auto-advance if preferences.autoplayEnabled
- Countdown Resting(90→1→0)

### 6. skipRest, startNextSetOrExercise, handleMonitorMetric, handleRepNotification, checkAutoStop, startAutoStartTimer, resetForNewWorkout, loadRoutine
- See full briefing for implementation details

## Timers (4 types)
1. **Auto-start:** 3s grab-to-start (Just Lift)
2. **Countdown:** 5s pre-workout (normal mode)
3. **Auto-stop:** 3s in danger zone (Just Lift)
4. **Rest:** 90s default between sets

## Rep Counter Integration
```dart
_repCounter.onRepEvent = (RepEvent event) {
  state = state.copyWith(repCount: _repCounter.getRepCount());
  // Emit haptics based on event type
  if (_repCounter.shouldStopWorkout()) {
    handleSetCompletion();
  }
};
```

## Dependencies (Stub if needed)
- BleRepository ✅
- WorkoutSessionDao ✅
- RepCounterFromMachine ⚠️ (can stub with TODO)
- MetricsCalculator ⚠️ (can stub with simple peak/avg)
- HapticActions ✅

## CRITICAL Notes
1. **Just Lift:** Auto-reset to Idle after SetSummary (line 1006)
2. **State Guards:** startNextSetOrExercise only from Resting
3. **Double-Trigger:** Use bool flags for auto-stop
4. **Cleanup:** Cancel all timers in dispose()

## Success Criteria
- 13 methods implemented
- 9-state machine with correct transitions
- 4 timers working
- Just Lift auto-resets to Idle
- Zero blocking errors
- Freezed generation successful

## Provider Structure
```dart
class WorkoutSessionNotifier extends StateNotifier<WorkoutSessionState> {
  final BleRepository _bleRepository;
  final WorkoutSessionDao _workoutSessionDao;
  final RepCounterFromMachine _repCounter;
  final MetricsCalculator _metricsCalculator;
  final HapticActions _hapticActions;

  Timer? _autoStartTimer;
  Timer? _restTimer;

  // 13 methods here

  @override
  void dispose() {
    _autoStartTimer?.cancel();
    _restTimer?.cancel();
    super.dispose();
  }
}
```

**FULL DETAILS:** Read `.cursor_briefing_workout_provider.md` for complete implementations
