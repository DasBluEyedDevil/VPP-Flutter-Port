# Workout History Screen - Flutter Implementation Brief (Screen 9/16)

**Source Analysis:** WORKOUT_HISTORY_ANALYSIS.md (comprehensive Kotlin analysis)
**Target:** Exact 1:1 match with Kotlin HistoryTab

## Implementation Tasks

### 1. Create 7 New Widgets

**lib/presentation/screens/history_tab.dart** (ConsumerWidget, ~100 lines)
- TopAppBar: "History" title + refresh IconButton
- StreamProvider watching workout sessions (limit 20, timestamp DESC)
- ListView.separated with WorkoutHistoryCard items
- Empty state when no workouts
- Pull-to-refresh (optional enhancement)

**lib/presentation/widgets/workout/workout_history_card.dart** (~250 lines)
- Complex card with gradient icon box + 2×2 metric grid
- Spring press animation (1.0 → 0.98 scale, 150ms)
- Exercise name (async lookup from exercise library)
- Relative timestamp formatting ("Today at 3:45 PM", "Yesterday at...", etc.)
- 4 metrics: Duration, Reps, Sets, Weight
- Delete button with confirmation
- Gradient icon: Teal (#14B8A6) → Cyan (#06B6D4)

**lib/presentation/widgets/common/enhanced_metric_item.dart** (~40 lines)
- Icon + label + value display
- Compact 2-column grid layout
- Icons: timer (duration), fitness_center (reps), format_list_numbered (sets), scale (weight)

**lib/presentation/widgets/common/empty_state.dart** (REUSE from other screens)
- Generic empty state widget
- Icon + message + optional action button

**lib/presentation/widgets/dialogs/delete_confirmation_dialog.dart** (REUSE if exists)
- "Delete Workout?" confirmation
- "This will permanently delete this workout session. This cannot be undone."

**lib/presentation/widgets/common/refresh_button.dart** (~30 lines)
- IconButton with rotation animation on tap
- 360° rotation, 500ms duration
- refresh icon

**lib/presentation/widgets/common/gradient_icon_box.dart** (REUSE from Settings Tab)
- 48×48dp gradient container
- Icon centered

### 2. Database Queries (Copilot Task - Separate)

**lib/data/database/daos/workout_dao.dart**
- Add method: `Stream<List<WorkoutSessionWithDetails>> watchRecentSessions(int limit)`
- Query joins workout_sessions with exercises
- ORDER BY timestamp DESC
- LIMIT 20

**Domain Model (if not exists):**
- WorkoutSessionWithDetails class with exercise name included

### 3. Critical Specifications from Analysis

**Card Layout:**
- 48×48dp gradient icon box (teal → cyan)
- 24dp FitnessCenter icon (white)
- Exercise name: titleLarge Bold
- Timestamp: bodyMedium, onSurfaceVariant color
- 2×2 metric grid with 8dp spacing
- Delete button: 40×40dp, top-right corner
- Card: 4dp elevation, 12dp radius, 16dp padding
- Border: 1dp #F5F3FF
- Spring animation: scale 1.0 → 0.98, 150ms

**Relative Date Formatting:**
```dart
String formatRelativeTimestamp(BigInt timestamp) {
  final dt = DateTime.fromMillisecondsSinceEpoch(timestamp.toInt());
  final now = DateTime.now();
  final diff = now.difference(dt);

  if (diff.inMinutes < 1) return 'Just now';
  if (diff.inHours < 1) return '${diff.inMinutes}m ago';
  if (diff.inDays < 1) return 'Today at ${DateFormat('h:mm a').format(dt)}';
  if (diff.inDays == 1) return 'Yesterday at ${DateFormat('h:mm a').format(dt)}';
  if (diff.inDays < 7) return DateFormat('EEEE').format(dt); // "Monday"
  return DateFormat('MMM d, yyyy').format(dt); // "Nov 12, 2025"
}
```

**Duration Formatting:**
```dart
String formatDuration(int seconds) {
  final minutes = seconds ~/ 60;
  final secs = seconds % 60;
  return '$minutes:${secs.toString().padLeft(2, '0')}';
}
```

**Sets Calculation:**
```dart
int calculateSets(int workingReps, int repsPerSet) {
  if (repsPerSet == 0) return 0;
  return (workingReps / repsPerSet).ceil();
}
```

**Exercise Name Lookup (CRITICAL OPTIMIZATION):**
- Batch fetch all exercise names at screen level
- Pass as Map<String, String> to cards
- Avoid 20 duplicate queries

### 4. State Management Pattern

```dart
final workoutHistoryProvider = StreamProvider<List<WorkoutSessionWithDetails>>((ref) {
  final dao = ref.watch(workoutDaoProvider);
  return dao.watchRecentSessions(20);
});
```

### 5. Testing Requirements

After implementation:
1. Run `flutter analyze` - must pass
2. Verify 20-session limit works
3. Test empty state display
4. Test delete with confirmation
5. Verify date formatting for various ages
6. Test spring animation smoothness
7. Check exercise name loading performance

### 6. Known Issues to Address

**From Analysis:**
1. ✓ Batch exercise name loading (optimize from Kotlin's inefficiency)
2. ⚠ Add loading indicator (Kotlin has none)
3. ⚠ Add error handling for exercise lookup failures
4. ⚠ Consider adding pagination/"Load More" (Kotlin hard-limits to 20)
5. ✓ Delete confirmation (implement properly)

### 7. Files to Create/Update

**NEW:**
- lib/presentation/screens/history_tab.dart
- lib/presentation/widgets/workout/workout_history_card.dart
- lib/presentation/widgets/common/enhanced_metric_item.dart
- lib/presentation/widgets/common/refresh_button.dart

**REUSE (verify exist):**
- lib/presentation/widgets/common/empty_state.dart
- lib/presentation/widgets/common/gradient_icon_box.dart
- lib/presentation/widgets/dialogs/delete_confirmation_dialog.dart

**UPDATE (Copilot):**
- lib/data/database/daos/workout_dao.dart

See WORKOUT_HISTORY_ANALYSIS.md for complete specifications.
